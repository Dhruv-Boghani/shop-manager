<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Billing - QR & Barcode Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link rel="stylesheet" href="/css/billing.css" />
</head>

<body>
  <%- include('../partials/navbar') %>

    <div class="container">
      <h2 class="title">ðŸ§¾ Scan Product Tags</h2>

      <form id="billingForm" class="form">
        <div class="form-group">
          <label for="customerName">Customer Name</label>
          <input type="text" id="customerName" placeholder="e.g., John Doe" required />
        </div>
        <div class="form-group">
          <label for="mobileNo">Mobile Number</label>
          <input type="text" id="mobileNo" placeholder="e.g., 9999999999" required />
        </div>
        <div class="form-group">
          <label for="totalAmount">Total Receiving Amount</label>
          <input type="number" id="totalAmount" placeholder="e.g., 500" required />
        </div>
      </form>

      <div class="scanner-section">
        <h3>QR / Barcode Scanner</h3>
        <div id="reader" class="reader-box"></div>
        <p class="last-scan">Last Scanned: <span id="lastResult">None</span></p>
      </div>

      <h3 class="subtitle">Scanned Tag IDs</h3>
      <table class="tag-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Tag ID</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tagTableBody"></tbody>
      </table>

      <div class="actions">
        <button class="btn green" onclick="makeBill()">ðŸ§¾ Make Bill</button>
        <a class="btn gray" href="/bill/changshop">Change Shop</a>
        <a class="btn home" href="/">Home</a>
      </div>

      <audio id="beep-sound" src="/sound/beep.mp3" preload="auto"></audio>
    </div>

    <script>
      const beep = new Audio("/sound/beep.mp3");
      beep.preload = "auto";
      beep.load();

      function playBeep() {
        beep.currentTime = 0;
        beep.play().catch(err => console.warn("Beep issue:", err));
      }

      let scannedTags = new Set();
      let barcodeBuffer = "";
      let lastScanTime = Date.now();

      document.addEventListener("keydown", function (e) {
        if (Date.now() - lastScanTime > 100) {
          barcodeBuffer = "";
        }

        if (e.key === "Enter") {
          const scannedCode = barcodeBuffer.trim();
          if (scannedCode) {
            addTagToTable(scannedCode);
            barcodeBuffer = "";
          }
        } else {
          barcodeBuffer += e.key;
        }

        lastScanTime = Date.now();
      });

      const lastResultEl = document.getElementById("lastResult");
      const tagTableBody = document.getElementById("tagTableBody");

      function addTagToTable(tagId) {
        if (scannedTags.has(tagId)) return;
        playBeep();
        scannedTags.add(tagId);

        const row = document.createElement("tr");
        row.innerHTML = `
        <td>${scannedTags.size}</td>
        <td>${tagId}</td>
        <td><button class="btn red" onclick="removeTag('${tagId}', this)">Remove</button></td>
      `;
        tagTableBody.appendChild(row);
        lastResultEl.innerText = tagId;
      }

      function removeTag(tagId, button) {
        scannedTags.delete(tagId);
        const row = button.closest("tr");
        row.remove();

        Array.from(tagTableBody.rows).forEach((row, index) => {
          row.cells[0].textContent = index + 1;
        });
      }

      const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
      html5QrcodeScanner.render((decodedText) => {
        addTagToTable(decodedText.trim());
      });

      function makeBill() {
        const customerName = document.getElementById("customerName").value.trim() || "Unknown Customer";
        const mobileNo = document.getElementById("mobileNo").value.trim() || "Unknown Number";
        const totalAmount = document.getElementById("totalAmount").value;

        totalAmount = totalAmount ?? 0;
        if (scannedTags.size === 0) return alert("No tags scanned.");

        const tagIds = Array.from(scannedTags);
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/billing";

        const inputs = {
          shopId: "<%= shopId %>",
          customerName,
          mobileNo,
          totalReceivingAmount: totalAmount,
        };

        for (const key in inputs) {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = key;
          input.value = inputs[key];
          form.appendChild(input);
        }

        tagIds.forEach(tagId => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = "tagIds[]";
          input.value = tagId;
          form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
        form.remove();
      }
    </script>
</body>

</html>