<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Billing - QR & Barcode Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="/css/billing.css" rel="stylesheet" />
</head>

<body>
  <div class="container py-5">
    <h2 class="mb-4 text-primary">ðŸ§¾ Scan Product Tags</h2>

    <form id="billingForm" class="row g-3 form-section">
      <div class="col-md-4">
        <label for="customerName" class="form-label">Customer Name</label>
        <input type="text" class="form-control" id="customerName" placeholder="e.g., John Doe" required />
      </div>
      <div class="col-md-4">
        <label for="mobileNo" class="form-label">Mobile Number</label>
        <input type="text" class="form-control" id="mobileNo" placeholder="e.g., 9999999999" required />
      </div>
      <div class="col-md-4">
        <label for="totalAmount" class="form-label">Total Receiving Amount</label>
        <input type="number" class="form-control" id="totalAmount" placeholder="e.g., 500" required />
      </div>
    </form>

    <div class="mb-3">
      <label for="cameraSelect" class="form-label">Select Camera</label>
      <select id="cameraSelect" class="form-select" style="max-width: 500px;"></select>
    </div>
    
    <div class="form-section">
      <h5 class="mb-3">ðŸ“· QR / Barcode Scanner</h5>
      <div id="reader" style="width: 100%; max-width: 500px;"></div>
      <p class="mt-3 mb-0"><strong>Last Scanned:</strong> <span id="lastResult" class="text-success">None</span></p>
    </div>

    <h5 class="mb-3">ðŸ§¾ Scanned Tag IDs</h5>
    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-dark">
          <tr>
            <th scope="col">#</th>
            <th scope="col">Tag ID</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody id="tagTableBody"></tbody>
      </table>
    </div>

    <div class="btn-group-custom mt-3">
      <button class="btn btn-success" onclick="makeBill()">ðŸ§¾ Make Bill</button>
      <a class="btn btn-outline-secondary" href="/bill/changshop">Change Shop</a>
      <a class="btn btn-outline-primary" href="/">Home</a>
    </div>

    <div id="jsonOutput" class="mt-4 p-3 bg-light border rounded d-none"></div>
    <audio id="beep-sound" src="/sound/beep.mp3" preload="auto"></audio>
  </div>

  <script>
    
    const beep = document.getElementById("beep-sound");
    let scannedTags = new Set();
    const lastResultEl = document.getElementById("lastResult");
    const tagTableBody = document.getElementById("tagTableBody");

    function playBeep() {
      beep.currentTime = 0;
      beep.play().catch((err) => console.warn("Beep play issue:", err));
    }

    function addTagToTable(tagId) {
      if (scannedTags.has(tagId)) return;
      playBeep();
      scannedTags.add(tagId);

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${scannedTags.size}</td>
        <td>${tagId}</td>
        <td><button class="btn btn-sm btn-danger" onclick="removeTag('${tagId}', this)">Remove</button></td>
      `;
      tagTableBody.appendChild(row);
      lastResultEl.textContent = tagId;
    }

    function removeTag(tagId, btn) {
      scannedTags.delete(tagId);
      const row = btn.closest("tr");
      row.remove();

      // Re-index the table
      Array.from(tagTableBody.rows).forEach((r, i) => {
        r.cells[0].textContent = i + 1;
      });
    }

    // Barcode scanner via keyboard
    let barcodeBuffer = "";
    let lastScanTime = Date.now();

    document.addEventListener("keydown", function (e) {
      if (Date.now() - lastScanTime > 100) {
        barcodeBuffer = "";
      }

      if (e.key === "Enter") {
        const scannedCode = barcodeBuffer.trim();
        if (scannedCode) {
          addTagToTable(scannedCode);
          barcodeBuffer = "";
        }
      } else {
        barcodeBuffer += e.key;
      }

      lastScanTime = Date.now();
    });

    // QR Scanner
  const cameraSelect = document.getElementById("cameraSelect");
  let currentCameraId = null;
    const html5QrCode = new Html5Qrcode("reader");

    function startScanner(cameraId) {
    html5QrCode.stop().catch(() => {}).finally(() => {
      html5QrCode.start(
        cameraId,
        { fps: 10 },
        (decodedText) => {
          addTagToTable(decodedText.trim());
        },
        (errorMessage) => {
          // Optional: console.log("QR error", errorMessage);
        }
      );
    });
  }
  
    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length) {
        const cameraId = cameras[0].id;
        html5QrCode.start(
          cameraId,
          {
            fps: 10
            
          },
          (decodedText) => {
            addTagToTable(decodedText.trim());
          },
          (errorMessage) => {
            // console.warn("QR Error", errorMessage);
          }
        );
      }
    }).catch(err => {
      console.error("Camera error:", err);
    });

    function makeBill() {
      const customerName = document.getElementById("customerName").value.trim() || "Unknown Customer";
      const mobileNo = document.getElementById("mobileNo").value.trim() || "Unknown Number";
      const totalAmount = document.getElementById("totalAmount").value;

      if (!totalAmount) {
        alert("Please enter total amount.");
        return;
      }

      if (scannedTags.size === 0) {
        alert("No tags scanned.");
        return;
      }

      const tagIds = Array.from(scannedTags);
      const form = document.createElement("form");
      form.method = "POST";
      form.action = "/billing";

      const inputs = {
        shopId: "<%= shopId %>",
        customerName,
        mobileNo,
        totalReceivingAmount: totalAmount,
      };

      for (const key in inputs) {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = key;
        input.value = inputs[key];
        form.appendChild(input);
      }

      tagIds.forEach(tagId => {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "tagIds[]";
        input.value = tagId;
        form.appendChild(input);
      });

      document.body.appendChild(form);
      form.submit();
    }
  </script>
</body>

</html>
